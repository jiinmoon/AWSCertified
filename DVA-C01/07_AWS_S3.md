AWS Simple Storage Service (S3)
===============================

**The infinitely scaling storage**.

S3 -- Buckets
-------------

S3 allows storage of **objects (files)** within **buckets (directories)**. At
first glance, S3 appears to have a file system like directory structure - but
this is a disguise that is used to only help organization.

**S3 Buckets require globally unique name and it is defined at regional
level**.

S3 -- Objects
-------------

- Each Objects have a Key where it is a _full path_.
    - i.e. given `s3://myBucket/myFile.jpg`, `myFile.jpg` is the key.
    - i.e. given `s3://myBucket/myFolder/myFile.jpg`, `myFolder/myFile.jpg` is
      the key.

- Key is composed of **prefix** and **object name**.
    - i.e. given `s3://myBucket/thisFolder/thatFolder/myFile.png`
    - `thisFolder/thatFolder` is the prefix.
    - `myFile.png` is the object name.

- Object values are content of the body;
    - Max object size is 5 TB;
    - If uploading an object > 5 GB, you must use multi-part upload.

- Objects has metadata, tags, and version id.

S3 -- Versioning
----------------

- You can create **version** of your files stored in S3.
- It is enabled at Bucket level.
- Same key overwrites will increment the version 1, 2, 3 and ...
- Best practice is always version your buckets:
    - It protects against unintended deltes.
    - Allows easy rollback to previous version.
- **Any file that is not versioned prior to enabling a versioning, it will be
  of version "null"**.
- **Suspending versioning does not delete previous versions**.

S3 -- Encryption for Objects
----------------------------

| Type | Description |
| --- | --- |
| SSE-S3 | Encrypts S3 objects using keys managed by AWS |
| SSE-KMS | Uses AWS Key Management Service (KMS) |
| SSE-C | Supply your own custom encryption keys |
| Client Side Encryption | Uploads encrypted files |

S3 -- SSE-S3
------------

- AWS S3 manages the key, and objects are encrypted server-side.
- Uses AES-256.
- Include the header : `"x-amz-server-side-encryption":"AES256"`.

S3 -- SSE-KMS
-------------

- Uses AWS KMS; KMS provides user control and audit trails.
- Encrypts using KMS Customer Master Key (CMK).
- Include the header : `"x-amz-server-side-encryption":"aws:kms"`.

S3 -- SSE-C
-----------

- You supploy your own key to encrypt the objects server-side.
- You will have to manage your own keys.
- HTTPS is requirement since key is to be passed over the traffic.

S3 -- Client Side Encryption
----------------------------

- Not only using your own key, but you also encrypt files before uploading it.
- Client is solely responsible for entire encrypt/decrypt cycle.

S3 -- SSL/TLS
-------------

- S3 exposes HTTP and HTTPS endpoints.
- HTTPS is always recommended over HTTP.

S3 -- Security
--------------

**User based** security is enforced with **IAM Policies** where it can control
who is allowed to make API calls to S3.

**Resource based** security is enforced by

- Bucket Policies - bucket wide rules.
- Object Access Control List (ACL)
- Bucket Access Control List (ACL)

**IAM principal can access an S3 object iff**

- The user IAM permission ALLOW it or the resource policy ALLOW it.
- **There should not be explicit DENY**.

S3 -- Bucket Policies
---------------------

- It is generated by **AWS Policy Generator**.

- It is a JSON based policies which defines:
    - resources : buckets and objects.
    - actions : set of APIs to ALLOW or DENY.
    - effect : ALLOW or DENY.
    - principal : the account or user to apply the policy to.

- It is used to
    - grant Public Access to the bucket (i.e. use S3 as static web host).
    - force objects to be encrpted at upload.
        - set `DenyUnencrptedObjects`.
    - grant access to another account (cross account access).

S3 -- Example Bucket Settings for Blocking Public Access
--------------------------------------------------------

- Blocking public access to buckets and objects are granted by
    - new ACLs
    - or, new public bucket or access point policies.

- Block public and cross account access to buckets and objects through any
  public bucket or access point policies.

S3 -- More Security
-------------------

**Network**

- Supports VPC Endpoints (for instances in private subnet).

**Logging and Audit**

- S3 Access Logs can be stored in other S3 Bucket.
- S3 API calls can be logged in AWS CloudTrail.

**User Security**

- MFA Delete : Multi-Factor Auth can be required in versioned buckets to
  delete objects.
- Pre-signed URLs : short lived URLs that grants access to objects.

S3 -- Websites
--------------

- S3 can host static websties which can be accessed over the web.
- `<Bucket-Name>.s3-webstite-<AWS-Region>.amazonaws.com`.
- Set the bucket policy to allow public read.

        Effect : ALLOW
        Principal : *
        Service : S3
        Action : GetObject

Cross Origin Resource Sharing (CORS)
------------------------------------

**Origin** is a scheme (protocol), host (domain) and a port. For example,
`https://www.example.com` is an origin that has HTTPS protocol, at port 443.

**Same Origin** refers to having a same _host_. For example
`http://example.com/app1` and `http://example.com/app2` has same origin.

Requests would not be fulfilled unless the other origin allows for the requests
using CORS header `Access-Control-Allow-Origin`.

For example, to access from one origin `http://www.this.com` to another origin
`http://www.other.com`, the web browser will first have to make a pre-flight
request to Cross Origin.

S3 -- CORS
----------

If a client does a cross-origin request on our S3 bucket, we need to enable the
correct CORS headers; you can allow for a specific origin, or from \*.

Web browser will perform GET request to S3 bucket html (enabled as a website)
and bucket will return a file (i.e. `index.html`). However, it will also
require the browser to make additional CORS requests if there are any resources
referenced on that S3 bucket html (i.e. an image that was used which is from
another origin).

As long as the bucket assets are configured correctly with header
`Access-Control-Allow-Origin:bucket-html.s3-website.us-west-1.amazonaws.com`,
it is allowed.

**CORS is enabled by the other origin, not the one that is referring from**.

`CORS_CONFIG.xml` should be used; for example:

```xml
<CORSConfiguration>
    <CORSRule>
        <AllowedOrigin>origin-bucket-url</AllowedOrigin>
        <AllowedMethod>GET</AllowedMethod>
        <MaxAgeSeconds>3000</MaxAgeSeconds>
        <AllowedHeader>Authorization</AllowedHeader.
    </CORSRule>
</CORSConfiguration>
```

S3 -- Consistency Model
-----------------------

**PUT** : READ after WRITE consistency.

- As soon as the file is PUT, you can GET.
- However, if we did GET prior to PUT, we may get 404.
    - i.e. GET 404 -> PUT 200 -> GET 404.
    - Eventually Consistent.

**DELETES** and **PUTS** : Eventual Consistency.

- If we read an object after upload, we could get an oler version.
- If we delete an object, it may still be available for a short while.

**We cannot request for a strong consistency**.
    






