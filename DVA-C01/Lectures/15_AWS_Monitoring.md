AWS Monitoring
==============

Monitoring?
-----------

We want to measure how is our application performing, and its behaviors such as

- application latency
- application outages
- customer related problems

Monitoring Services in AWS
--------------------------

**AWS CloudWatch**

- Metrics
- Logs : collect, analyze and store log files.
- Events : send notifications when events trigger.
- Alarms : react in real-time to metrics and event.

**AWS XRay**

- Troubleshooting application performance and errors.
- It provides distributed tracing of microservices.

**AWS CloudTrail**

- Internal monitoring of API calls.
- Audit changes to AWS resources by the users within the AWS account.

---

CloudWatch Metrics
------------------

- CloudWatch Metric provide metrics for many AWS services.
- Metrics can be i.e. CPU Utilization, Network Inbound Count, ...
- Metrics belong to **namespaces**.
- **Dimension** is an attribute of a metric (instance id, environment).
- Up to 10 dimensions per metric.
- Metrics have time-stamps.

CloudWatch Metrics -- EC2 Detailed Monitoring
---------------------------------------------

- EC2 instance metrics have metrics recorded every 5 mins.
- Can enable detailed monitoring to record every min at a cost.

CloudWatch Metrics -- Custom Metrics
------------------------------------

- It is possible to define and send your own custom metrics.
- You can use dimensions to segment metrics:
    - Instance.id
    - Envrionment.name

- Metric resolution:
    - Standard: 1 min
    - High Resolution: up to 1 second (`StorageResolution` API)

- Use the `PutMetricData` API.
- Use exponential backoff strategy in case of throttling error.

CloudWatch Alarms
-----------------

- Alarms are used to trigger notifications for any metric.
- Alarms can notify ASG, EC2, SNS,
- Alarm states:
    - `OK`
    - `INSUFFICIENT_DATA`
    - `ALARM`
- Period
    - Need to specify length of time in seconds to evaluate the metrics.
    - High resolution custom metrics can only choose 10 sec or 30 sec.

i.e. ASG alarms set to increase or decrease the number of EC2 insances as
network traffics increase or decrease.

CloudWatch Logs
---------------

- Applications can send logs to CloudWatch using the SDK.
- CloudWatch can collect log from other AWS services such as:
    - EB
    - ECS : logs from app within container
    - Lambda : function logs
    - VPC Flow Logs
    - API Gateway
    - CloudTrail based on filter
    - CloudWatch Log agents : i.e. running on EC2 instances
    - Route53 : DNS queries

- CloudWatch Logs can be exported to
    - Batch exporter to S3 buckets for archive.
    - Stream to ElasticSearch cluster for futher analytics.

- CloudWatch Logs can use filter expressions.

- Logs storage architecture:
    - Logs group : arbitary namel usually representing an app.
    - Log stream : instances within app, log files and containers.
- Can set a log expiration policies.
- Using the AWS CLI, we can -tail CloudWatch logs.
- In order to send the logs to CloudWatch, **make sure that IAM permissions are
  set**.

CloudWatch Logs -- EC2
----------------------

- By default, no logs from an EC2 instance will go to CloudWatch; to do so, you
  need to run a **CloudWatch agent** on the machine to push the logs.

- **It needs to have a correct IAM permissions**.

- It can also be setup for On-Premises EC2 instances.

CloudWatch Logs -- Agent and Unified Agent
------------------------------------------

These are used for virtual servers (EC2, On-Premise machines).

**CloudWatch Log Agent**

- Older version.
- Can only send to CloudWatch Logs

**CloudWatch Unified Agent**

- Collects additional system-level metrics such as RAM, processes, etc.
- Collects logs to send to CloudWatch Logs.
- Centralized configuration using SSM Parameter Store.

CloudWatch Logs -- Metric Filter
--------------------------------

- CloudWatch Logs can use a filter expression.
    - i.e. find a specific IP inside of a log or count occurrences of "ERROR".
    - Metric filters can also beused to trigger alarms.

- **Filters do not retroactively filter data**. It only works from the time
  that it has been created.

CloudWatch Events
-----------------

- Schedule : Cron jobs.
- Event Pattern : Event rules to react to a service triggers.
    - i.e. CodePipeline state changing.
- Triggers to Lambda functions, SQS/SNS/Kinesis.
- CloudWatch Events create a small JSON to inform about the changes.

---

Amazon EventBridge
------------------

EventBridge is the next evolution step of CloudWatch Events.

- **Default event bus** : generated by AWS services.
- **Partner event bus** : recevie events from other SaaS or applications such
  as Zendesk, DataDog, Segment, etc.
- **Custom event bus** : user application can publish its own events.
- **Rules** : how to process events.

Amazon EventBridge -- Schema Registry
-------------------------------------

- EventBridge can analyze the evens in your bus and infer the **schema**.
- **Schema Registry** allows you to generate code for your app that will know
  in advance how the data is structured in the event bus.

Amazon EventBridge vs CloudWatch Events
---------------------------------------

- EventBridge extends the capabilities of CloudWatch Events.
- Uses the same API and endpoint as well as underlying infrastructure.
- EventBridge allows adding event buses for custom applications and 3rd party
  SaaS apps.
- Overtime, CloudWatch Events is to be replaced by EventBridge.

---

AWS X-Ray
---------

Typically debugging in Production involves:

- local testing.
- adding log statements.
- redeploying in production.

However, it is a difficult process for monolith - not to mention the
distributed systems. For this reason, X-Ray offers a tracing that provides
a common view into how your application behaves.

X-Ray -- Visual Analysis
------------------------

X-Ray provides graphical representations of our services; clients making
a request and it traces how this request is propagates along to our services.

Its advancatages are as follows:

- troubleshooting perforamnce issue (where is the bottleneck?).
- understand dependencies in a microservice architecture.
- pinpoint service issues.
- review request behavior.
- find errors and exceptions.
- identify users that are impacted.

X-Ray works with following AWS services:

- AWS Lambda
- EB
- ECS
- ELB
- API Gateway
- EC2 instances or any application service including On-Premises.

X-Ray -- Tracing
----------------

- Tracing is an end-to-end following of a "request".
- Each component dealing with the request will add its own "trace".
- Tracing is made of segments and subsegments.
- Annotations can be added to provide extra information.

X-Ray -- Creation
-----------------

The application code must import the AWS X-Ray SDK, which is used to capture:

- class to AWS services.
- HTTP / HTTPS requests.
- Database Calls.
- Queue calls.

Then, install X-Ray daemon or enable X-Ray AWS Integration where X-Ray daemon
works as a low level UDP packet interceptor (AWS Lambda and other services
already run this daemon).

**Each application must have appropriate IAM permissions to write to X-Ray**.

X-Ray -- Troubleshooting
------------------------

If X-Ray is not working on an EC2 instance,

- ensure that the EC2 has a proper IAM Role attached.
- ensure that the EC2 instance is running the X-Ray daemons.

To enable X-Ray on Lambda, ensure that it has an IAM execution role with proper
policy, `AWSX-rayWriteOnlyAccess`.

X-Ray -- Instrumentation in code
--------------------------------

**Instrumentation** refers to measure of product's performance, diagnose
errors, and to write trace information. To instrument our application, we use
**X-Ray SDK**.

```js
var app = express();

var AWSXray = require('aws-xray-sdk');
app.use(AWSXRay.express.openSegment('MyApp'));

app.get('/', function (req, res) {
    res.render('index');
});

app.use(AWSXRay.express.closeSegment());
```

X-Ray -- Concepts
-----------------

- **Segments** are what each application and services will send.
- **Subsegments** are more details within the segment.
- **Trace** are segments collected together to form an end-to-end trace.
- **Sampling** decreases the amount of requests sent to X-Ray (reduce costs).
- **Annotations** are key-value pairs used to **index** traces and used to
  filter.
- **Metadata** are key-value pairs which are not indexed.

X-Ray agent and daemon is able to send traces cross-account through its
configuration, but it requires a correct IAM permissions. The agent will assume
the IAM Role assigned to it.

X-Ray -- Sampling Rules
-----------------------

With sampling rules, we can control the amount of data being recorded;
modifying the sampling rules does not require modification to the code.

By default, X-Ray SDK records the first request each second, and 5% of
additional requests after. This one request per second is the **reservoir**
which ensures that at least one trace is recorded each second as long as the
service is serving requests. Later, 5% is the **rate** which is the additional
requests beyond the reservoir size are sampled.

You can create custom rules on **reservoir** and **rate**; once changed daemon
automatically updates itself.

X-Ray -- Write APIS used by X-Ray daemon
----------------------------------------

Example: `arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess`

```
"Effect": "Allow",
"Action": [
    "xray:PutTraceSegments",
    "xray:PutTelemetryRecords",
    "xray:GetSamplingRules",
    "xray:GetSamplingTargets",
    "xray:GetSamplingStatisticSummaries"
],
"Resource": [ "*" ]
```

- `PutTraceSegments` upload segment docs to X-Ray.
- `PutTelemtryRecords` used by X-Ray daemon to upload telemetry such as
    - SegmentsReceivedCount
    - SegmentsRejectedCount
    - BackendConnectionErrors
- `GetSamplingRules` retrieves sampling rules automatically.

X-Ray -- Read APIs
------------------

- `GetServiceGraph` is the main graph.
- `BatchGetTraces` retrieves a list of races specified by ID; each trace is
  a collection of segment documents that originates from a single request.
- `GetTraceSummaries` retrieves IDs and annotations fro traces available for
  a specified time frame using an optiona filter; to get full traces, pass the
  trace IDs to `BatchGetTraces`.

X-Ray -- EB
-----------

EB platforms include the X-Ray daemon already; we can run the daemon by setting
an option in the EB console or with a configuration file in
`.ebextensions/xray-daemon.config`.

```yaml
option_settings:
    aws:elasticbeanstalk:xray:
        XRayEnabled: true
```

Make sure that the instance profile has the correct IAM permissions such that
X-Ray daemon can function correctly. Application code should be instrumented
with X-Ray SDK.

Note that it is not provided for Multi-container Docker platform which is
managed by the ECS.

X-Ray -- ECS
------------

**ECS Cluster**

We can run the X-Ray container as a daemon where each EC2 instance will have at
least one X-Ray daemon container.

Or, we can run X-Ray container as a "side-car" where each application container
will have the X-Ray daemon.

**Fargate Cluster**

Here, we do not have a control; only option is to use the "side-car" pattern.

```json
{
    "name" : "xray-daemon",
    "image" : "...",
    ...
    "portMappings" : [
        {
            "hostPort" : 0,
            "containerPort" : 2000,
            "protocol" : "udp",
        }
    ],
},
...
```

Notice that "portMappings" section has a port open for 2000 and uses UDP
protocol - required by the X-Ray. Also, the environment variable must be set:

        AWS_XRAY_DAEMON_ADDRESS="xray-daemon:2000"

---

AWS CloudTrail
--------------

It provides governance, complican and audit for your AWS account and it is
enabled by default. This logs all history of events and API calls made within
your AWS account by console, SDK, CLI, or AWS services.

_If a resource is deleted, CloudTrail is first place to check and investigate_.

CloudTrail vs CloudWatch vs X-Ray
---------------------------------

**CloudTrail**

- Audit API calls made by users, services and AWS console.
- useful for track down unauthorized calls or root cause of chages made.

**CloudWatch**

- CloudWatch Metrics for overtime monitoring.
- CloudWatch Logs for storing application logs.
- CloudWatch Alarms to send notifications in case of unexpected metrics.

**X-Ray**

- Automated Trace analysis and central service map visualization.
- Latency, Errors and Fault analysis.
- Request tracking across a distributed systems.
